# DBT Transformations - Running DBT Commands

## üöÄ QUICK START - How to Run DBT

**The simplest and recommended way to run DBT:**

```bash
cd "/path/to/Migration agent"
bash run-dbt.sh run --profiles-dir . --project-dir .
```

This wrapper script automatically handles:
- ‚úÖ Loading .env credentials
- ‚úÖ Extracting TARGET_SCHEMA from migration_config.yml  
- ‚úÖ Running DBT from the correct directory
- ‚úÖ Using the virtual environment's dbt executable

## ‚ö†Ô∏è IMPORTANT: Always Check migration_config.yml First!

Before running any DBT commands, **ALWAYS read** `../migration_config.yml` (in the parent directory).

This file contains ALL critical migration settings:
- `target_schema` ‚Üí becomes TARGET_SCHEMA environment variable
- `source_schema` ‚Üí should match `source_database` in dbt_project.yml
- `client_name` ‚Üí should match `clientName` in dbt_project.yml
- `source_crm` ‚Üí determines which template folder to use
- `tables_to_transform` ‚Üí which tables to migrate
- `master_id` ‚Üí fallback user ID for transformations

## ‚ö†Ô∏è IMPORTANT: Environment Configuration

DBT reads environment variables from the **parent directory** (Migration agent folder), NOT from this DBT directory.

### Required Files in Parent Directory

1. **`.env`** - Database credentials (DO NOT create .env in this DBT folder)
   ```
   REDSHIFT_USER=your_username
   REDSHIFT_PASSWORD=your_password
   REDSHIFT_HOST=your_host
   REDSHIFT_PORT=5439
   REDSHIFT_DB=your_database
   ```

2. **`migration_config.yml`** - Migration configuration including `target_schema`

## Virtual Environment Setup

DBT is installed in a Python virtual environment located at `DBT/redshift_env/`.

### First Time Setup

```bash
cd "/path/to/Migration agent"
bash setup.sh  # This creates the venv and installs all dependencies
```

### If DBT Command Not Found

If you get `bash: dbt: command not found`, use one of these approaches:

**Option 1: Use the run-dbt.sh wrapper (RECOMMENDED)**
```bash
cd "/path/to/Migration agent"
bash run-dbt.sh run --profiles-dir . --project-dir .
```

**Option 2: Use the full path to dbt executable**
```bash
cd "/path/to/Migration agent/DBT"
set -a && source ../.env && set +a
export TARGET_SCHEMA=$(grep '^target_schema:' ../migration_config.yml | sed 's/target_schema: *"\?\([^"]*\)"\?/\1/' | tr -d '"')
./redshift_env/bin/dbt run --profiles-dir . --project-dir .
```

**Option 3: Activate venv (may not work if PATH issues)**
```bash
cd "/path/to/Migration agent/DBT"
source redshift_env/bin/activate
set -a && source ../.env && set +a
export TARGET_SCHEMA=$(grep '^target_schema:' ../migration_config.yml | sed 's/target_schema: *"\?\([^"]*\)"\?/\1/' | tr -d '"')
dbt run --profiles-dir . --project-dir .
```

## How to Run DBT

### From the Migration Agent Directory (Parent) - PREFERRED METHOD

Use the wrapper script that loads environment variables:

```bash
# Run DBT models
./run-dbt.sh run

# Run specific models
./run-dbt.sh run --select people_*

# Test models
./run-dbt.sh test

# Debug connection
./run-dbt.sh debug

# Compile models without running
./run-dbt.sh compile

# Run and test in one command
./run-dbt.sh build
```

### The Wrapper Script (`run-dbt.sh`)

The `run-dbt.sh` script automatically:
1. Loads environment variables from parent `.env` file
2. Extracts `target_schema` from `migration_config.yml`
3. Changes to the DBT directory
4. Runs your DBT command
5. Returns to the parent directory

## DBT Configuration Files

### `profiles.yml` 
Defines the database connection using environment variables:
- `REDSHIFT_HOST` - from parent `.env` file
- `REDSHIFT_PORT` - from parent `.env` file (defaults to 5439)
- `REDSHIFT_DB` - from parent `.env` file (defaults to 'dev')
- `REDSHIFT_USER` - from parent `.env` file
- `REDSHIFT_PASSWORD` - from parent `.env` file
- `TARGET_SCHEMA` - **IMPORTANT**: This comes from `target_schema` in parent `migration_config.yml`, NOT from .env
  * The `run-dbt.sh` script automatically extracts this value
  * If running manually, you must export it: `export TARGET_SCHEMA="lechley_migrated_cursor"`

### `dbt_project.yml`
Contains project-specific variables:
- `source_database` - Source schema name
- `clientName` - Client name/slug
- `agency_id` - Agency ID
- `master_id` - Fallback user ID
- `domain` - Domain name

## Common DBT Commands

```bash
# Run all models
./run-dbt.sh run

# Run models for specific client
./run-dbt.sh run --select clients.client_name.*

# Run models with specific prefix
./run-dbt.sh run --select people_*
./run-dbt.sh run --select companies_*

# Run a single model
./run-dbt.sh run --select model_name

# Test all models
./run-dbt.sh test

# Test specific model
./run-dbt.sh test --select people_*

# Debug connection issues
./run-dbt.sh debug

# Show documentation
./run-dbt.sh docs generate
./run-dbt.sh docs serve

# Clean compiled files
./run-dbt.sh clean

# Compile without running
./run-dbt.sh compile
```

## Workflow for Running Transformations

1. **Configure** `migration_config.yml` in parent directory with:
   - `target_schema` - Where transformed data will be written
   - Client-specific variables

2. **Set up** `dbt_project.yml` with project variables:
   - `source_database`
   - `clientName`
   - `master_id`
   - etc.

3. **Run DBT transformations**:
   ```bash
   cd "/path/to/Migration agent"
   ./run-dbt.sh run
   ```

4. **Run QA tests** after successful transformation:
   ```bash
   cd "QA Suite" && npm run qa
   ```

5. **Fix any issues** in DBT models and re-run

## Important Notes

### DO NOT:
- ‚ùå Create a `.env` file in this DBT directory
- ‚ùå Run `dbt` commands directly from this directory (they won't have env vars)
- ‚ùå Modify `profiles.yml` to hardcode credentials

### DO:
- ‚úÖ Use `./run-dbt.sh` from the parent directory
- ‚úÖ Keep credentials in parent `.env` file
- ‚úÖ Set `target_schema` in parent `migration_config.yml`
- ‚úÖ Update `dbt_project.yml` for each migration

## Model Organization

```
models/
‚îú‚îÄ‚îÄ clients/          # Client-specific transformations
‚îÇ   ‚îî‚îÄ‚îÄ {clientName}/ # One folder per client
‚îú‚îÄ‚îÄ bullhorn/         # Default Bullhorn transformations
‚îú‚îÄ‚îÄ recruitcrm/       # Default RecruitCRM transformations
‚îú‚îÄ‚îÄ vincere/          # Default Vincere transformations
‚îî‚îÄ‚îÄ ...               # Other CRM templates
```

### Creating Client Models

1. Copy default CRM models from `models/{sourceCRM}/` to `models/clients/{clientName}/`
2. Customize the transformations as needed for the client
3. Only edit files in `models/clients/{clientName}/` folder

## Checking DBT Connection

Before running transformations, verify connection:

```bash
./run-dbt.sh debug
```

This will show:
- Configuration details
- Database connection status
- Any environment variable issues

## Troubleshooting

### "Could not find profile named 'default'"
- Make sure you're running from parent directory using `./run-dbt.sh`
- Check that `profiles.yml` exists in this DBT directory

### "Database connection failed"
- Verify credentials in parent `.env` file
- Run `./run-dbt.sh debug` to see connection details
- Check network access to Redshift

### "target_schema not set"
- Verify `migration_config.yml` in parent directory has `target_schema: "schema_name"`

### Environment variables not loading
- Use `./run-dbt.sh` wrapper script (don't run `dbt` directly)
- Check that `.env` file exists in parent directory
- Verify `.env` file has proper format (no spaces around `=`)
- If running manually, load env vars: `set -a && source ../.env && set +a`
- Don't forget TARGET_SCHEMA: extract it from migration_config.yml

### "dbt: command not found"
- DBT is installed in virtual environment at `DBT/redshift_env/bin/dbt`
- ALWAYS use the wrapper script: `bash run-dbt.sh run` from parent directory
- OR use full path: `./redshift_env/bin/dbt` from DBT directory
- Don't rely on activating the venv - PATH may not update correctly

## Quick Reference

| Task | Command |
|------|---------|
| Run all transformations | `./run-dbt.sh run` |
| Run specific table prefix | `./run-dbt.sh run --select people_*` |
| Test transformations | `./run-dbt.sh test` |
| Debug connection | `./run-dbt.sh debug` |
| Clean compiled files | `./run-dbt.sh clean` |
| Full build (run + test) | `./run-dbt.sh build` |

## After Running DBT

Always run the QA suite to validate the transformations:

```bash
cd "QA Suite" && npm run qa
# Or test specific tables:
cd "QA Suite" && npm run qa people companies
```

Fix any QA failures by editing the DBT models and re-running the transformations.

